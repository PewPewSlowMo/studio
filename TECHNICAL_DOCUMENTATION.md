# Техническая документация по приложению CallSync Central

## 1. Введение

**CallSync Central** — это веб-приложение на базе Next.js, предназначенное для мониторинга, управления и аналитики работы колл-центра, интегрированного с **Asterisk PBX**. Приложение предоставляет интерфейсы для операторов, супервизоров и администраторов, каждый из которых имеет свой набор инструментов и отчетов.

### 1.1. Стек технологий

-   **Фреймворк:** Next.js (с App Router)
-   **Язык:** TypeScript
-   **UI:** React, ShadCN UI, Tailwind CSS
-   **Управление состоянием:** React Hooks (useState, useEffect, useMemo), без внешних библиотек
-   **Работа с формами:** React Hook Form, Zod для валидации
-   **Взаимодействие с Asterisk:**
    -   **ARI (Asterisk REST Interface):** Для получения данных о состоянии каналов, звонков и операторов в реальном времени.
    -   **AMI (Asterisk Manager Interface):** Для выполнения команд (например, получение списка очередей, пользователей) и прослушивания событий.
-   **База данных CDR:** MySQL (для хранения Call Detail Records)
-   **База данных приложения:** SQLite (для хранения пользователей, контактов CRM, обращений и т.д.)

---

## 2. Архитектура и структура проекта

Приложение построено на современной архитектуре Next.js с использованием серверных компонентов и серверных действий (`Server Actions`) для взаимодействия с бэкендом и внешними сервисами.

### 2.1. Структура директорий

```
/
├── data/                  # Хранилище данных
│   ├── app.db             # Локальная база данных SQLite
│   ├── config.json        # Конфигурация подключений (ARI, AMI, CDR)
│   ├── appeals.json       # (Для первоначальной миграции)
│   ├── crm.json           # (Для первоначальной миграции)
│   └── users.json         # (Для первоначальной миграции)
│
├── public/                # Статические ассеты (нет в проекте)
│
├── src/
│   ├── actions/           # Серверные действия (бэкенд-логика)
│   │   ├── app-db.ts      # Инициализация и подключение к SQLite
│   │   ├── ami.ts         # Функции для работы с AMI
│   │   ├── appeals.ts     # CRUD для обращений (в SQLite)
│   │   ├── ari.ts         # Функции для работы с ARI
│   │   ├── auth.ts        # Логика аутентификации (из SQLite)
│   │   ├── cdr.ts         # Функции для работы с БД CDR
│   │   ├── config.ts      # CRUD для файла конфигурации
│   │   ├── crm.ts         # Логика работы с CRM (в SQLite)
│   │   └── users.ts       # CRUD для пользователей (в SQLite)
│   │
│   ├── app/               # Роутинг и страницы приложения
│   │
│   ├── components/        # Переиспользуемые UI-компоненты
│   │
│   └── lib/               # Вспомогательные утилиты и типы
│
├── LOCAL_SETUP.md         # Инструкция по локальной установке
├── TECHNICAL_DOCUMENTATION.md # Этот файл
└── ...                    # Конфигурационные файлы
```

### 2.2. Управление конфигурацией

Ключевой особенностью приложения является отказ от использования `.env` файлов для хранения чувствительных данных (паролей, хостов). Вместо этого используется единый файл `data/config.json`, который редактируется через UI в панели администратора.

-   **Преимущества:** Упрощает настройку для нетехнических пользователей, позволяет менять настройки "на лету", не требует перезапуска сервера.
-   **Недостатки:** Хранение паролей в открытом виде в JSON-файле. Для production-окружения рекомендуется внедрить шифрование или использовать защищенные хранилища секретов.

### 2.3. Потоки данных и Real-time

Для получения данных в реальном времени используется **механизм поллинга (polling)**.

1.  **Состояние операторов и звонков (Дашборд, Панель оператора):**
    -   Клиентский компонент с интервалом в 2-3 секунды вызывает серверное действие `getOperatorState` (`src/actions/asterisk.ts`).
    -   Это действие отправляет HTTP-запрос к Asterisk REST Interface (ARI) для получения актуального статуса PJSIP-конечной точки (`endpoint`) и связанных с ней каналов.
    -   Данные возвращаются на клиент, где обновляется UI (статус оператора, информация об активном звонке).

2.  **История звонков (Отчеты, Аналитика):**
    -   При загрузке страницы или изменении диапазона дат вызывается серверное действие `getCallHistory` (`src/actions/cdr.ts`).
    -   Это действие устанавливает прямое соединение с MySQL базой данных, выполняет SQL-запрос к таблице `cdr` и возвращает результат.

---

## 3. Детальное описание модулей

### 3.1. Серверные действия (`src/actions`)

Это ядро бэкенд-логики приложения. Все файлы в этой директории содержат директиву `'use server';`.

-   **`app-db.ts`**: **Ключевой модуль для работы с данными приложения.**
    -   `getDbConnection`: Устанавливает соединение с файлом базы данных `data/app.db`.
    -   `initializeDatabase`: **Очень важная функция.** При первом запуске она:
        1.  Создает структуру таблиц (`users`, `crm_contacts`, `appeals`) в базе данных SQLite, если они не существуют.
        2.  Проверяет, пусты ли таблицы. Если да, то **автоматически выполняет однократную миграцию данных** из соответствующих JSON-файлов (`users.json`, `crm.json`, `appeals.json`) в базу данных SQLite.
        Это позволяет сохранить существующие данные при переходе с файловой системы на СУБД.

-   **`users.ts`, `crm.ts`, `appeals.ts`**: Реализуют CRUD-операции (создание, чтение, обновление, удаление) для соответствующих сущностей. Теперь они выполняют SQL-запросы к базе данных SQLite через соединение, полученное из `app-db.ts`.

-   **`ami.ts`**: Использует библиотеку `asterisk-manager` для подключения к AMI. Основные функции:
    -   `runAmiCommand`: Абстракция для выполнения команд AMI.

-   **`ari.ts`**: Взаимодействует с ARI через `fetch`.
    -   `fetchFromAri`: Общая функция для выполнения GET-запросов к ARI.
    -   `getOperatorState`: **Ключевая функция для real-time мониторинга.** Она использует ARI для надежного определения статуса оператора и номера звонящего.

-   **`cdr.ts`**: Работает с MySQL базой данных истории звонков.
    -   `createCdrConnection`: Создает соединение с базой данных.
    -   `getCallHistory`, `getMissedCalls`: Выполняют SQL-запросы для получения списков звонков.

### 3.2. Основные страницы и компоненты

Логика большинства страниц осталась прежней, но теперь все операции с пользователями, контактами и обращениями происходят через вызов серверных действий, которые обращаются к базе данных SQLite, а не к JSON-файлам.

#### 3.2.1. Аутентификация (`/login`)
-   Серверное действие `loginUser` (`src/actions/auth.ts`) теперь ищет пользователя в таблице `users` в `app.db`.

#### 3.2.2. Рабочее место оператора (`/operator`)
-   Сохранение карточки обращения (`saveAppeal`) теперь создает или обновляет запись в таблице `appeals` в `app.db`.
-   Поиск контакта (`findContactByPhone`) выполняется по таблице `crm_contacts`.
-   Задачи на перезвон извлекаются из таблицы `appeals`.

#### 3.2.3. Администрирование (`/admin`)
-   **Настройки системы:** Логика не изменилась, по-прежнему работает с `data/config.json`.
-   **Управление пользователями:** Компонент `UserManagement` теперь вызывает `getUsers`, `addUser`, `updateUser` и `deleteUser`, которые выполняют SQL-запросы к таблице `users`.

---
## 4. База данных и хранилище

### 4.1. SQLite (База данных приложения)

-   **Файл:** `data/app.db`
-   **Назначение:** Основное хранилище для всех сущностей приложения: пользователи (`users`), контакты CRM (`crm_contacts`) и карточки обращений (`appeals`).
-   **Преимущества:**
    -   **Надежность и атомарность:** В отличие от JSON-файлов, SQLite обеспечивает транзакционность и целостность данных.
    -   **Производительность:** Быстрее при большом количестве записей.
    -   **Переносимость:** Единый файл, который легко бэкапить и переносить.
-   **Миграция:** При первом запуске система автоматически переносит данные из `users.json`, `crm.json` и `appeals.json` в базу данных SQLite. После этого JSON-файлы больше не используются для чтения или записи.

### 4.2. MySQL (CDR)

-   **Таблица:** `cdr`
-   **Назначение:** Хранение детальной информации о каждом завершенном звонке. Это основной источник данных для всех исторических отчетов.
-   **Ключевые поля:** `calldate`, `src`, `dst`, `disposition`, `uniqueid`, `linkedid`, `duration`, `billsec`.

### 4.3. JSON-файлы

-   `data/config.json`: **Единственный активно используемый JSON-файл.** Хранит конфигурацию подключений к внешним сервисам (ARI, AMI, CDR).
-   `data/users.json`, `data/crm.json`, `data/appeals.json`: Используются **только для однократной первоначальной миграции** данных в SQLite. После успешной миграции они больше не читаются и не изменяются приложением.
